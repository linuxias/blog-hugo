+++
title = "CPU Profiling"
+++

# CPU Analysis

### uptime

시스템 부하 평균을 표시한다. load average의 값은 앞에서부터 1분, 5분, 15분 동안의 평균 부하이다.

``` bash
uptime
 08:41:55 up 1 day, 17:41,  4 users,  load average: 0.28, 0.24, 0.27
```

부하평균은 CPU 자원에 대한 요구사항으로써, ** 실행 중인 스레드 개수 + 대기열의 스레드 개수 **이다. 만약 부하 평균이 호스트 머신의 CPU 개수보다 크면 스레드를 처리하기에 CPU가 부족한 상황이며, 대기열에 여러 스레드가 CPU를 할당받기 위해 대기하고 있는 상태라고 파악할 수 있다.


### vmstat

vmstat은 가상 메모리 통계 정보를 제공한다. 

```bash
$vmstat
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free     buff    cache    si   so    bi    bo   in   cs us sy id wa st
 0  0   1024 12837676 7238384 10378596    0    0    14    39   24   19  2  1 97  0  0
```

위 컬럼에서 아래 정보에서 각 컬럼에 대한 내용은 아래와 같다.

 - r : 실행 중이거나 실행을 위해 기다리는 프로세스 개수
 - us : 사용자 시간
 - sy : 시스템 시간
 - id : 유휴
 - wa : I/O 대기. 스레드가 디스크 I/O를 기다리느라 블록된 것을 표시

### mpstat (multiprocessor statistics tool)

CPU 별 통계 확인 가능

```bash
mpstat -P ALL 1
Linux 4.15.0-76-generic (linuxias) 	2020년 02월 17일 	_x86_64_	(8 CPU)

       CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
       all    5.02    0.00    7.78    0.00    0.00    0.00    0.00    0.00    0.00   87.20
         0    0.99    0.00    1.98    0.00    0.00    0.00    0.00    0.00    0.00   97.03
         1    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
         2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
         3    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
         4   37.62    0.00   59.41    0.00    0.00    0.00    0.00    0.00    0.00    2.97
         5    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
         6    0.00    0.00    1.01    0.00    0.00    0.00    0.00    0.00    0.00   98.99
         7    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00

```

mpstat을 실행한 호스트머신에는 8개의 CPU가 있으며 각 통계정보는 위와 같다. 각 정보가 표시하는 내역은 다음과 같다.
 
 - CPU : 논리적 CPU ID
 - %usr : 사용자 시간
 - %nice : nice가 지정된 프로세스의 사용자 시간
 - %sys : 시스템 시간
 - %iowatit : I/O 대기
 - %irq : 하드웨어 인터럽트 CPU 사용률
 - %soft : 소프트웨어 인터럽트 CPU 사용률
 - %guest : 게스트 가상 머신을 실행하는데 사용한 시간
 - %idle : 유휴 시간

위 정보를 기반으로 현재 호스트머신의 대부분의 CPU는 idle 상태이며, 4번 CPU에서 특정한 작업이 이뤄지고 있고 있음을 알 수 있다. usr / sys / idle 항목을 잘 확인하면 CPU 별 CPU 사용률과 사용자, 커널 사용 시간에 대한 비율을 확인할 수 있다. 사용자 어플리케이션이 코드를 실행하는 데 소모한 CPU 시간이 `usr` 이며, 커널 영역 코드 실행하는데 걸린 시간이 `sys`이다. 커널 시간에는 시스템 콜 처리 시간, 커널 스레드가 보낸 시간, 인터럽트 처리 시간 등이 포함된다.

### sar (system activity reporter)

`sar` 는 `mpstat`와 유사하게 사용되며 현재 시스템 상태를 관찰하고, 과거 통계 정보를 저장하도록 할 수 있다.

```bash
sar -P ALL 1
Linux 4.15.0-76-generic (linuxias) 	2020년 02월 17일 	_x86_64_	(8 CPU)

                CPU     %user     %nice   %system   %iowait    %steal     %idle
                all      5.75      0.00      8.12      0.00      0.00     86.12
                  0      3.00      0.00      5.00      0.00      0.00     92.00
                  1      0.99      0.00      0.99      0.00      0.00     98.02
                  2      7.92      0.00      7.92      0.00      0.00     84.16
                  3      1.00      0.00      0.00      0.00      0.00     99.00
                  4      1.98      0.00      2.97      0.99      0.00     94.06
                  5      0.00      0.00      2.02      0.00      0.00     97.98
                  6     30.69      0.00     44.55      0.00      0.00     24.75
                  7      0.99      0.00      1.98      0.00      0.00     97.03

```
